input {
    # TCP 输入 - 用于接收 Spring Boot 日志
    tcp {
        mode => "server"
        host => "0.0.0.0"
        port => 38001
        codec => json_lines
        type => "springboot"
    }
    
    # Beats 输入 - 用于 Filebeat/Metricbeat
    beats {
        port => 5044
        type => "beats"
    }
}

filter {
    # 处理 Spring Boot 日志
    if [type] == "springboot" {
        # 如果消息是 JSON 格式，解析它
        if [message] =~ /^\{.*\}$/ {
            json {
                source => "message"
                skip_on_invalid_json => true
            }
        }
        
        # 添加主机信息
        mutate {
            add_field => { "[@metadata][target_index]" => "springboot" }
        }
        
        # 提取应用名称
        if [app_name] {
            mutate {
                add_field => { "application" => "%{app_name}" }
            }
        } else if [spring.application.name] {
            mutate {
                add_field => { "application" => "%{[spring.application.name]}" }
            }
        } else {
            mutate {
                add_field => { "application" => "unknown" }
            }
        }
        
        # 处理日志级别
        if [level] {
            mutate {
                uppercase => [ "level" ]
            }
        }
        
        # 添加时间戳
        if [timestamp] {
            date {
                match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss.SSS", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
                target => "@timestamp"
            }
        }
        
        # 清理不需要的字段
        mutate {
            remove_field => [ "port", "host" ]
        }
    }
    
    # 处理 Beats 输入
    if [type] == "beats" {
        mutate {
            add_field => { "[@metadata][target_index]" => "beats" }
        }
    }
}

output {
    # Spring Boot 日志输出到 Elasticsearch
    if [@metadata][target_index] == "springboot" {
        elasticsearch {
            hosts => ["http://elasticsearch:9200"]
            user => "elastic"
            password => "${ELASTICSEARCH_PASSWORD}"
            index => "springboot-%{[application]}-%{+YYYY.MM.dd}"
            # 数据流配置，自动管理索引生命周期
            action => "create"
        }
    }
    
    # Beats 日志输出
    if [@metadata][target_index] == "beats" {
        elasticsearch {
            hosts => ["http://elasticsearch:9200"]
            user => "elastic"
            password => "${ELASTICSEARCH_PASSWORD}"
            index => "beats-%{+YYYY.MM.dd}"
            action => "create"
        }
    }
    
    # 调试输出（可选，生产环境建议注释掉）
    # stdout {
    #     codec => rubydebug
    # }
}
