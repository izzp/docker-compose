# 放在 http 上下文（conf.d 文件顶层），用于解析 Docker 内部服务名并定义上游
resolver 127.0.0.11 valid=30s;
upstream prometheus_up {
    server prometheus:9090;
}

server {
    listen 9090;
    server_name _;

    # 简单 IP 白名单：精确匹配与 172. 前缀匹配
    access_by_lua_block {
        local allow = { ["127.0.0.1"] = true, ["10.0.10.19"] = true }
        local remote = ngx.var.remote_addr or ""
        if allow[remote] or remote:sub(1,4) == "172." then
            return
        end
        ngx.log(ngx.WARN, "prometheus proxy: denied access from ", remote)
        ngx.header.content_type = "text/plain"
        ngx.say("403 Forbidden")
        return ngx.exit(ngx.HTTP_FORBIDDEN)
    }

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 5s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_pass http://prometheus_up$request_uri;
    }

    # 日志
    #access_log /var/log/nginx/prometheus_access.log;
    #error_log /var/log/nginx/prometheus_error.log warn;
}
