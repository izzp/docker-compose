# nginx 配置：监听 0.0.0.0:39100，反向代理到 node_exporter 服务（主机网络模式）
server {
    listen 0.0.0.0:39100;
    server_name _;

    # 使用 OpenResty 的 Lua 执行 IP 白名单检查（比纯 nginx allow/deny 更灵活）
    # 请在下方的 allow 表中替换为你的 Prometheus 抓取主机 IP
    access_by_lua_block {
        local allow = {
            ["127.0.0.1"] = true,
            ["10.0.0.5"] = true,
            ["10.0.0.6"] = true,
        }
        local remote = ngx.var.remote_addr or ""
        if allow[remote] or remote:sub(1,4) == "172." then
            return
        end
        ngx.log(ngx.WARN, "访问被拒绝：", remote)
        return ngx.exit(ngx.HTTP_FORBIDDEN)
    }

    # 代理到本机的 node_exporter（host 网络下监听 127.0.0.1:9100）
    location / {
        proxy_pass http://127.0.0.1:9100;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # 可选：自定义访问/错误日志路径
    # access_log /var/log/nginx/node_proxy_access.log;
    # error_log /var/log/nginx/node_proxy_error.log;

    # 说明：修改白名单或端口后重载 OpenResty：
    # docker exec node_exporter_proxy nginx -t && docker exec node_exporter_proxy nginx -s reload
}


